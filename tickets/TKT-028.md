---
status: open
priority: high
created: 2026-01-30
---
# TKT-028: Eliminate GitHub REST API reads - use local git only

## Problem

The client makes excessive GitHub REST API calls for read operations. This violates the architecture guideline: "All read operations should use local git, not REST API."

Current issues:
- `getRecentActivity` makes ~25+ API calls per invocation
- 404 errors for deleted files still in commit history
- Short `staleTime` (5s) causes repeated refetches
- Rate limit concerns (5,000/hour)

## Solution

**Wholesale replacement** of all GitHub REST API read operations with local git reads.

### Change Detection
Add a `heads` tRPC endpoint that returns current HEAD sha for each repo from MCP server's local clones. Client polls this (on focus or every 60s), compares to browser git HEADs, and fetches only changed repos.

### Hook Naming (simplified)
Rename verbose hooks to clearer names:
- `useMultiRepoBoards` → `useBoards`
- `useMultiRepoTicketsParsed` → `useTickets`  
- `useMultiRepoFiles` → `useFiles`
- New: `useActivity` (recent commits across repos)

## Scope

### GitHub API functions to DELETE from `lib/github.ts`:
- `getRepoContents` - use browser git `listFiles()`
- `getFileContent` - use browser git `readFile()`
- `getFileTree` - use browser git `listFiles()`
- `getRepoCommits` - use browser git `log()`
- `getCommitDetail` - use browser git `getCommitFiles()`
- `getFileCommitHistory` - use browser git `getFileHistory()`
- `getHeadSha` - use new `heads` endpoint
- `getGitCommitObject` - use browser git
- `getFileContentAtCommit` - use browser git `readFileAtCommit()`
- `getRepoStats` - derive from browser git

### GitHub API functions to KEEP:
- `listRepos` - repo discovery (acceptable per CLAUDE.md)
- `createGitHubRepo` - write operation (acceptable per CLAUDE.md)

### Files to update:
1. `lib/github.ts` - delete read functions, keep only `listRepos` and `createGitHubRepo`
2. `lib/content.ts` - use browser git hooks instead of REST API
3. `lib/tickets.ts` - use browser git hooks instead of REST API
4. `lib/timelines.ts` - use browser git hooks instead of REST API
5. `lib/reports.ts` - use browser git hooks instead of REST API
6. `trpc/routers/repos.ts` - remove REST API calls, add `heads` endpoint
7. `routes/api/repo-bootstrap.ts` - remove or refactor
8. `routes/api/repo-history.ts` - remove (browser git handles this)
9. `components/projects-overview.tsx` - use `useActivity` hook
10. `components/tickets-overview.tsx` - use `useActivity` hook

## Implementation

### 1. Backend
- Add `heads` tRPC procedure: returns `{ [repoSlug]: headSha }` from MCP server's local clones
- Remove all other read-based tRPC procedures that use REST API

### 2. Frontend  
- Add polling hook that compares `heads` response to browser git HEADs
- Trigger `git fetch` only for repos where HEAD differs
- Create `useActivity` hook reading commits from browser git
- Migrate all components to browser-git hooks
- Delete unused REST API functions

## Outcome
After this ticket, `lib/github.ts` should only contain ~50 lines for `listRepos` and `createGitHubRepo`. All other GitHub REST API code is deleted.
