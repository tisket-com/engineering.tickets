---
status: open
priority: high
created: 2026-01-30
---
# TKT-028: Replace REST API polling with ref-based change detection

## Problem

The client makes excessive GitHub REST API calls when displaying recent activity. The `getRecentActivity` tRPC procedure fetches commits, commit details, and file contents via REST API, causing:

- ~25+ API calls per invocation (5 repos × 5 commits × commit details + file previews)
- Repeated calls for deleted files (e.g., `test-delete.md`) causing 404 errors
- Tripled requests due to short `staleTime` (5s) and `refetchOnWindowFocus`
- Violation of architecture guidelines (should use local git, not REST API)

## Solution

Replace REST API polling with a ref-based change detection pattern:

1. **Add `getRefs` tRPC endpoint** - Returns current HEAD sha for each repo from MCP server's local clones
2. **Client polls refs** (e.g., every 30-60s or on window focus)
3. **Compare to browser git HEADs** - Only fetch repos where HEAD changed
4. **Read all data from browser git clone** - Commits, file contents, previews

## Implementation

### Backend (tRPC)
- Add `getRefs` procedure that reads HEAD from MCP server's local git clones
- Remove or deprecate `getRecentActivity` endpoint

### Frontend
- Create polling hook for refs comparison
- Create `useMultiRepoRecentActivity` hook (similar to existing `useMultiRepoBoards`)
- Update `ProjectsOverview` and `TicketsOverview` to use browser-git based hooks
- Remove REST API calls for commits/files from overview pages

## Benefits
- Eliminates REST API rate limit concerns (5,000/hour)
- Git protocol operations (fetch) have separate, generous limits
- Faster - local reads instead of network calls
- Simpler - single ref check instead of multiple API calls
- Consistent with existing patterns (`useMultiRepoBoards` already does this)
