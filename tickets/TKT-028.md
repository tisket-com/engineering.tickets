---
status: open
priority: high
created: 2026-01-30
---
# TKT-028: Remove all GitHub REST API calls from client

## Problem

The client makes direct GitHub REST API calls for read and write operations. This violates the architecture guideline: "All read operations should use local git, not REST API."

Current issues:
- `getRecentActivity` makes ~25+ API calls per invocation
- 404 errors for deleted files still in commit history
- Short `staleTime` (5s) causes repeated refetches
- Rate limit concerns (5,000/hour)
- Client bypasses MCP server for operations it should handle

## Solution

**Delete `lib/github.ts` entirely.** All operations should flow through:
- **Reads**: Browser git clone (via git protocol fetch from GitHub)
- **Writes**: tRPC → MCP server (which handles GitHub operations)

### Change Detection
Add a `heads` tRPC endpoint that returns current HEAD sha for each repo from MCP server's local clones. Client polls this (on focus or every 60s), compares to browser git HEADs, and triggers a `git fetch` only for repos where HEAD differs.

Note: `clone` happens once on first repo access (stored in IndexedDB via LightningFS). All subsequent updates use `fetch` to pull new commits - never re-cloning.

### Hook Renaming
Simplify verbose hook names:
| Old | New |
|-----|-----|
| `useMultiRepoBoards` | `useBoards` |
| `useMultiRepoTicketsParsed` | `useTickets` |
| `useMultiRepoFiles` | `useFiles` |
| (new) | `useActivity` |

## Scope

### Delete entirely:
- `client/src/lib/github.ts` - all 549 lines
- `client/src/routes/api/repo-bootstrap.ts` - uses REST API
- `client/src/routes/api/repo-history.ts` - uses REST API

### Migrate to browser git:
- `lib/content.ts` - use `useFiles` / `useGitFile` patterns
- `lib/tickets.ts` - use `useTickets` hook
- `lib/timelines.ts` - create `useTimelines` hook
- `lib/reports.ts` - create `useReports` hook

### Migrate to MCP server:
- Repo creation: already handled by MCP `create_project` / `create_team` tools
- Repo discovery: MCP server knows what repos exist (workspaces track membership)

### Update components:
- `components/projects-overview.tsx` - use `useActivity` hook
- `components/tickets-overview.tsx` - use `useActivity` hook
- `trpc/routers/repos.ts` - remove REST API imports, add `heads` endpoint

## Implementation

### 1. Add `heads` endpoint
```ts
// tRPC router
heads: protectedProcedure
  .input(z.object({ repoSlugs: z.array(z.string()) }))
  .query(async ({ input }) => {
    // Read HEAD from MCP server's local clones
    return { heads: { [slug]: sha, ... } }
  })
```

### 2. Add polling hook
```ts
function useHeadsPolling(repoSlugs: string[]) {
  // Poll `heads` endpoint on window focus / every 60s
  // Compare to browser git HEADs  
  // Call repo.fetch() for repos where HEAD differs
  // Never re-clone - fetch only pulls new commits
}
```

### 3. Create `useActivity` hook
```ts
function useActivity(repoSlugs: string[]) {
  // Read recent commits from browser git clones via repo.log()
  // Return combined, sorted activity feed
}
```

### 4. Rename hooks
- Rename `useMultiRepoBoards` → `useBoards`
- Rename `useMultiRepoTicketsParsed` → `useTickets`
- Rename `useMultiRepoFiles` → `useFiles`

### 5. Delete GitHub REST API code
- Delete `lib/github.ts`
- Delete `routes/api/repo-bootstrap.ts`
- Delete `routes/api/repo-history.ts`
- Remove all imports of deleted functions

## Outcome
After this ticket:
- Zero GitHub REST API calls from client
- All reads from browser git clone
- All writes through MCP server
- Simpler, faster, no rate limit concerns
