---
status: in_progress
priority: medium
created: 2026-01-28
---
# TKT-025: Migrate MCP server from isomorphic-git to native git

## Problem

The MCP server currently uses `isomorphic-git` for all git operations. This was likely chosen for simplicity, but isomorphic-git is designed for environments where native git isn't available (browsers, edge functions). On the server, this creates unnecessary limitations:

1. **No worktree support** - Can't isolate concurrent users working on the same repo
2. **Commit-per-write** - Currently every write/delete commits and pushes immediately, creating noisy history
3. **Missing features** - Less mature than native git, missing edge case handling

## Research

See [git-server-patterns.md](../../git-overview/git-server-patterns.md) for detailed analysis of how production services handle git operations:

- **GitLab Gitaly** - RPC over native git, process caching
- **Soft Serve** - Hook system, SQLite for metadata
- **simple-git** - Built-in scheduler with concurrency control
- **Dugite/GitHub Desktop** - GIT_ASKPASS for credentials

## Proposed Solution

Replace isomorphic-git with `simple-git`. Use worktrees for per-user isolation and explicit `commit_changes` for batched commits.

### Why simple-git?

- **Built-in scheduler** - Configurable `maxConcurrentProcesses` (default 2)
- **Error handling** - Fatal errors purge the queue to prevent cascading failures
- **Plugin system** - Hooks for auth, logging, spawn customization
- **Full worktree support** - Native git commands

### Architecture

```
User A (Claude Code)              User B (Claude Code)
       │                                 │
       ▼                                 ▼
   Worktree A                       Worktree B
   /tmp/sessions/user-a             /tmp/sessions/user-b
       │                                 │
       └──────────┬──────────────────────┘
                  │
                  ▼
            Primary Clone
            /repos/engineering.tickets
                  │
                  ▼
              GitHub
            (origin/main)
```

### Session-Worktree Mapping

Each user gets a worktree, created lazily on first write:

```
1. First write operation for user
   └─► git worktree add /tmp/sessions/{userId} -b session/{userId}

2. Subsequent writes (same user)
   └─► Reuse existing worktree, stage changes

3. User calls commit_changes
   └─► Commit, merge to main, push, cleanup worktree
```

### Write Operations Return Commit Hint

Every write operation reminds the agent to commit:

```typescript
async function writeFile(userId: string, path: string, content: string) {
  const worktree = await getOrCreateWorktree(userId);
  await fs.writeFile(join(worktree.path, path), content);
  await git(worktree.path).add(path);
  
  const pendingFiles = await getPendingFiles(worktree);
  
  return {
    success: true,
    path,
    message: `Wrote ${path}`,
    pending_files: pendingFiles,
    hint: `${pendingFiles.length} file(s) pending. Call commit_changes when done to save all changes.`
  };
}
```

Claude sees:
```json
{
  "success": true,
  "path": "tickets/TKT-026.md",
  "pending_files": ["tickets/TKT-025.md", "tickets/TKT-026.md"],
  "hint": "2 file(s) pending. Call commit_changes when done to save all changes."
}
```

This keeps the agent informed and in control - no magic timeouts.

### Commit Strategy

**Explicit `commit_changes` tool only.** No auto-commit timeout.

- Claude calls `commit_changes` after completing write operations
- Tool description guides usage: *"Call this after making write operations to save all changes"*
- Provides immediate feedback - changes pushed as soon as Claude is done

**Risk:** Claude forgets to call `commit_changes`

**Mitigations:**
1. Every write response includes reminder hint
2. Orphaned changes stay in worktree - next session picks up where it left off
3. Periodic cleanup of stale worktrees (>24 hours old)

### Credentials via GIT_ASKPASS

Use GIT_ASKPASS for secure token handling (pattern from Dugite/GitHub Desktop):

```typescript
function createAskpassScript(token: string): string {
  const script = join(tmpdir(), `askpass-${Date.now()}.sh`);
  writeFileSync(script, `#!/bin/sh\necho "${token}"\n`);
  chmodSync(script, 0o700);
  return script;
}

// Usage with simple-git
await git.env('GIT_ASKPASS', createAskpassScript(token)).push();
```

Benefits:
- No tokens in command line args (visible in `ps`)
- No tokens stored in git config
- Script deleted after use

### `commit_changes` Flow

```
1. Commit staged changes in session worktree
2. Fetch latest from origin/main
3. Merge origin/main into session branch
4. If conflicts:
   → Return conflict details to Claude
   → Claude resolves and calls commit_changes again
5. If clean:
   → Checkout main in primary clone
   → Merge session branch (fast-forward)
   → Push to origin
   → Remove worktree and session branch
   → Return success with commit SHA
```

### Tool Response Examples

**Success:**
```json
{
  "success": true,
  "commit": "abc123f",
  "message": "Committed and pushed 3 files",
  "files": ["tickets/TKT-025.md", "README.md", "docs/api.md"]
}
```

**Conflict:**
```json
{
  "success": false,
  "conflict": true,
  "files": ["tickets/TKT-025.md"],
  "message": "Merge conflict in tickets/TKT-025.md. Resolve and call commit_changes again."
}
```

## Implementation Tasks

1. **Replace isomorphic-git with simple-git**
   - Add `simple-git` dependency
   - Configure scheduler: `maxConcurrentProcesses: 4`
   - Update all git operations in `mcp/src/operations/`

2. **Add worktree management**
   - Create worktree lazily on first write per user
   - Track active worktrees in session state
   - Return pending files list with each write

3. **Add credentials handling**
   - Implement GIT_ASKPASS script creation
   - Clean up scripts after use
   - Pass via simple-git's `.env()` method

4. **Add `commit_changes` tool**
   - Commits staged changes in session worktree
   - Fetches and merges latest main (detects conflicts)
   - If clean: merges to main, pushes to origin
   - Returns conflict details if merge fails
   - Tool description instructs Claude when to call it

5. **Update write operations**
   - Return `pending_files` array with each write
   - Include hint reminding agent to call `commit_changes`

6. **Add stale worktree cleanup**
   - Periodic job to clean up worktrees older than 24 hours
   - Log warning if uncommitted changes are discarded

7. **Handle edge cases**
   - Merge conflicts: return to Claude for resolution
   - Multiple concurrent users on same repo: worktrees provide isolation
   - Server restart: worktrees persist on disk, can be recovered

## Files to Change

- `mcp/src/operations/repos.ts` - Replace isomorphic-git with simple-git
- `mcp/src/operations/files.ts` - Stage changes, return pending files hint
- `mcp/src/operations/tickets.ts` - Stage changes, return pending files hint
- `mcp/src/operations/boards.ts` - Stage changes, return pending files hint
- `mcp/src/operations/git.ts` - New commit_changes handler, worktree management
- `mcp/src/session.ts` - Track worktree state, pending files
- `mcp/src/tools/index.ts` - Add commit_changes tool definition
- New: `mcp/src/lib/worktree.ts` - Worktree lifecycle management
- New: `mcp/src/lib/askpass.ts` - GIT_ASKPASS script creation/cleanup
