---
status: open
priority: medium
created: 2026-01-28
---
# TKT-025: Implement session-based branching for MCP write operations

## Problem

Currently, each write/delete operation in the MCP server commits and pushes immediately. This creates noisy commit history and doesn't provide transactional semantics for multi-step operations.

## Proposed Approach

Change the commit/push strategy so that during a completion:
1. Branch to a session-specific branch (e.g., `session/{sessionId}`)
2. Individual tool calls (writes, deletes, etc.) commit to the session branch
3. At the end of the completion, merge the session branch back and push
4. Implement cleanup for failed completions or unexpected termination

## Key Challenge: Branch Isolation

**How do we ensure branch isolation when multiple completions run on the same server?**

Options to consider:
- **Worktree per session**: Use `git worktree` to create isolated working directories for each session
- **Locking mechanism**: Lock repos during active sessions (limits concurrency)
- **Stash/checkout dance**: Stash changes between operations (fragile)
- **Separate clone per session**: Clone to temp directory per session (expensive)

The worktree approach seems most promising - each session gets its own worktree pointing to its session branch, allowing true parallel operations on the same repo.

## Additional Considerations

- Session timeout/cleanup for abandoned sessions
- How to handle merge conflicts if main moves during a session
- Whether to expose session management to Claude (explicit start/commit) or keep it implicit
