---
status: in_progress
priority: medium
created: 2026-01-28
---
# TKT-025: Migrate MCP server from isomorphic-git to native git

## Problem

The MCP server currently uses `isomorphic-git` for all git operations. This was likely chosen for simplicity, but isomorphic-git is designed for environments where native git isn't available (browsers, edge functions). On the server, this creates unnecessary limitations:

1. **No worktree support** - Can't isolate concurrent sessions working on the same repo
2. **Commit-per-write** - Currently every write/delete commits and pushes immediately, creating noisy history
3. **Missing features** - Less mature than native git, missing edge case handling

## Proposed Solution

Replace isomorphic-git with native git (shell out directly or use `simple-git` wrapper). This enables worktree-based session isolation and batched commits.

### Session Isolation via Worktrees

Each active session gets its own worktree:

```
git worktree add /tmp/sessions/{sessionId} -b session/{sessionId}
# ... writes happen in isolated worktree ...
# on commit: merge to main, push, cleanup worktree
```

### Hybrid Commit Strategy

**Primary: Explicit `commit_changes` tool**
- Claude calls this after completing write operations
- Tool description guides usage: "Call after making write operations to commit and push changes"
- Provides immediate feedback - changes pushed as soon as Claude is done

**Fallback: Timeout-based auto-commit**
- If no MCP requests for ~15 seconds after a write, auto-commit and push
- Safety net for: forgotten commits, completion ending unexpectedly, crashes
- 15 seconds chosen because gaps within a completion are 4-12 seconds

### Flow

```
write/delete tool → stages changes in session worktree (no commit yet)
commit_changes tool → commits + merges to main + pushes + cleanup
timeout (15s inactivity after write) → same as commit_changes
new completion detected → commit previous session first, then create new worktree
```

## Investigation Summary

Logged MCP requests to understand session boundaries. Key findings:

| What | Finding |
|------|---------|
| X-Session-Id header | Not sent by Claude Code; falls back to user ID |
| `_meta.claudecode/toolUseId` | Unique per tool call, not per completion |
| jsonrpc request IDs | Increment continuously, don't reset between completions |
| Gaps within completion | 4-12 seconds |
| Gaps between completions | Minutes (user think time) |
| Headers | `mcp-protocol-version: 2024-11-05`, `user-agent: claude-code/2.1.22` |
| Notifications | None observed |

**Conclusion:** No explicit completion boundary signals from client. Timeout detection works reliably as a fallback.

## Implementation Tasks

1. **Replace isomorphic-git with native git**
   - Use `simple-git` or shell out directly
   - Update all git operations in `mcp/src/operations/`

2. **Add worktree management**
   - Create worktree on first write of a session
   - Track active worktrees in session state
   - Cleanup on commit or timeout

3. **Add `commit_changes` tool**
   - Commits staged changes in session worktree
   - Merges to main branch
   - Pushes to remote
   - Cleans up worktree
   - Tool description instructs Claude when to call it

4. **Add timeout-based auto-commit**
   - Background process monitors sessions with pending changes
   - Triggers commit after 15 seconds of inactivity
   - Same logic as explicit commit_changes

5. **Handle edge cases**
   - Merge conflicts if main moved during session
   - Cleanup for abandoned sessions
   - Multiple concurrent sessions on same repo

## Files to Change

- `mcp/src/operations/repos.ts` - Replace isomorphic-git with native git
- `mcp/src/operations/files.ts` - Stage changes instead of immediate commit
- `mcp/src/operations/tickets.ts` - Stage changes instead of immediate commit
- `mcp/src/operations/boards.ts` - Stage changes instead of immediate commit
- `mcp/src/operations/git.ts` - New commit_changes handler, worktree management
- `mcp/src/session.ts` - Track worktree state, pending changes
- `mcp/src/tools/index.ts` - Add commit_changes tool definition
- New: `mcp/src/lib/worktree.ts` - Worktree lifecycle management
- New: `mcp/src/lib/commit-timeout.ts` - Background timeout monitoring
