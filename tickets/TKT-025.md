---
status: in_progress
priority: medium
created: 2026-01-28
---
# TKT-025: Migrate MCP server from isomorphic-git to native git

## Problem

The MCP server currently uses `isomorphic-git` for all git operations. This was likely chosen for simplicity, but isomorphic-git is designed for environments where native git isn't available (browsers, edge functions). On the server, this creates unnecessary limitations:

1. **No worktree support** - Can't isolate concurrent sessions working on the same repo
2. **Commit-per-write** - Currently every write/delete commits and pushes immediately, creating noisy history
3. **Missing features** - Less mature than native git, missing edge case handling

## Proposed Solution

Replace isomorphic-git with native git (shell out directly or use `simple-git` wrapper). This enables worktree-based session isolation and batched commits.

### Session Isolation via Worktrees

Each active session gets its own worktree:

```
git worktree add /tmp/sessions/{sessionId} -b session/{sessionId}
# ... writes happen in isolated worktree ...
# on commit: merge to main, push, cleanup worktree
```

### Hybrid Commit Strategy

**Primary: Explicit `commit_changes` tool**
- Claude calls this after completing write operations
- Tool description guides usage: "Call after making write operations to commit and push changes"
- Provides immediate feedback - changes pushed as soon as Claude is done

**Fallback: Timeout-based auto-commit**
- If no MCP requests for ~15 seconds after a write, auto-commit and push
- Safety net for: forgotten commits, completion ending unexpectedly, crashes
- 15 seconds chosen because gaps within a completion are 4-12 seconds

### `commit_changes` Flow

```
1. Commit staged changes in session worktree
2. Fetch latest from origin/main
3. Merge origin/main into session branch
4. If conflicts:
   → Return conflict details to Claude
   → Claude resolves and calls commit_changes again
5. If clean:
   → Checkout main in primary clone
   → Merge session branch (fast-forward)
   → Push to origin
   → Remove worktree and session branch
   → Return success with commit SHA
```

### Tool Response Examples

**Success:**
```json
{
  "success": true,
  "commit": "abc123f",
  "message": "Committed and pushed 3 files",
  "files": ["tickets/TKT-025.md", "README.md", "docs/api.md"]
}
```

**Conflict:**
```json
{
  "success": false,
  "conflict": true,
  "files": ["tickets/TKT-025.md"],
  "message": "Merge conflict in tickets/TKT-025.md. Resolve and call commit_changes again."
}
```

## Investigation Summary

Logged MCP requests to understand session boundaries. Key findings:

| What | Finding |
|------|---------|
| X-Session-Id header | Not sent by Claude Code; falls back to user ID |
| `_meta.claudecode/toolUseId` | Unique per tool call, not per completion |
| jsonrpc request IDs | Increment continuously, don't reset between completions |
| Gaps within completion | 4-12 seconds |
| Gaps between completions | Minutes (user think time) |
| Headers | `mcp-protocol-version: 2024-11-05`, `user-agent: claude-code/2.1.22` |
| Notifications | None observed |

**Conclusion:** No explicit completion boundary signals from client. Timeout detection works reliably as a fallback.

## Implementation Tasks

1. **Replace isomorphic-git with native git**
   - Use `simple-git` or shell out directly
   - Update all git operations in `mcp/src/operations/`

2. **Add worktree management**
   - Create worktree on first write of a session
   - Track active worktrees in session state
   - Cleanup on commit or timeout

3. **Add `commit_changes` tool**
   - Commits staged changes in session worktree
   - Fetches and merges latest main (detects conflicts)
   - If clean: merges to main, pushes to origin
   - Returns conflict details if merge fails
   - Tool description instructs Claude when to call it

4. **Add timeout-based auto-commit**
   - Background process monitors sessions with pending changes
   - Triggers commit after 15 seconds of inactivity
   - Same logic as explicit commit_changes
   - On conflict: leaves changes staged, notifies on next request

5. **Handle edge cases**
   - Merge conflicts: return to Claude for resolution
   - Abandoned sessions: periodic cleanup of stale worktrees
   - Multiple concurrent sessions on same repo: worktrees provide isolation

## Files to Change

- `mcp/src/operations/repos.ts` - Replace isomorphic-git with native git
- `mcp/src/operations/files.ts` - Stage changes instead of immediate commit
- `mcp/src/operations/tickets.ts` - Stage changes instead of immediate commit
- `mcp/src/operations/boards.ts` - Stage changes instead of immediate commit
- `mcp/src/operations/git.ts` - New commit_changes handler, worktree management
- `mcp/src/session.ts` - Track worktree state, pending changes
- `mcp/src/tools/index.ts` - Add commit_changes tool definition
- New: `mcp/src/lib/worktree.ts` - Worktree lifecycle management
- New: `mcp/src/lib/commit-timeout.ts` - Background timeout monitoring
