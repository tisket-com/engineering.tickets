---
status: resolved
priority: high
created: 2026-02-01
---
# TKT-032: MCP git safety checks to prevent cross-repo contamination

## Problem

MCP server git operations were accidentally affecting the user's local working directory instead of the intended team/project repos. This caused:

- Staged changes in the local tisket app to be wiped by `git reset --hard`
- Tickets being committed to the wrong repository
- Session branches appearing in unrelated repos

Root cause: The `REPOS_PATH` was set to a relative path (`./repos`) which could resolve ambiguously, and there were no safety checks to validate the target repo before destructive operations.

## Solution

Implemented multi-layer safety checks in `mcp/src/lib/worktree.ts`:

1. **Namespaced repo paths** - Repos now live in dedicated directories:
   - Dev: `~/.tisket-mcp/repos/`
   - Prod: `/tmp/tisket-repos` (ephemeral, re-clones on cold start)

2. **Marker file system** - Each MCP-managed repo gets a `.tisket-mcp-managed` file on clone containing metadata (org, repoSlug, timestamp)

3. **Validation before destructive ops** - `validateMcpManagedRepo()` checks:
   - Path is under `REPOS_PATH` (prevents operating outside managed dir)
   - Marker file exists (prevents operating on user repos)
   - Remote URL matches expected org/repo (catches misrouted operations)

4. **Clear error messages** - Operations blocked with specific security errors

## Files Changed

- `mcp/src/lib/worktree.ts` - Added validation logic and safe path defaults
- `mcp/src/operations/repos.ts` - Creates marker file on clone
- `mcp/src/session.ts` - Updated REPOS_PATH default
- `mcp/.env.local` - Removed relative `REPOS_PATH=./repos`

## Testing

- Created ticket in tisket-hris team
- Verified repo cloned to `~/.tisket-mcp/repos/tisket-hris.tickets/`
- Verified marker file created with correct metadata
- Verified main tisket repo was not affected (checked reflog)
- Ticket appears correctly in app UI
