---
status: open
priority: high
created: 2026-02-01
---
# TKT-033: Implement GitHub App authentication for multi-tenant repository access

## Summary

Replace the current single `GITHUB_PAT` + `GITHUB_ORG` approach with GitHub App authentication, allowing each WorkOS organization to connect their own GitHub account/org as the upstream repository.

## Architecture

```
WorkOS Org ────→ GitHub Installation ────→ GitHub Org/Account

org_01ABC...  ──→  install_12345  ──→  tisket-com
org_02DEF...  ──→  install_67890  ──→  acme-corp
```

All users within a WorkOS organization share the same GitHub connection.

## Repository Access Strategy

**Important**: We use "Only select repositories" during installation to avoid accessing customer codebases. Tisket only needs access to repos it creates.

### Fresh Install
1. User installs with "Only select repositories" (none selected initially)
2. Tisket creates repos as needed (`developer-guide`, `engineering.tickets`, etc.)
3. App automatically gains access to repos it creates
4. Customer's codebases are never visible to Tisket

### Reconnect / Reinstall
1. User clicks "Reconnect GitHub"
2. We look up their existing repos from our DB (using stored GitHub repo IDs)
3. After installation callback, we use GitHub API to restore access:
   ```
   PUT /user/installations/{installation_id}/repositories/{repository_id}
   ```
4. App regains access to previously created repos

### Schema Update for Repo ID Storage

Store GitHub's repo ID when creating repos to enable reconnection:

```typescript
interface Repo {
  slug: string;
  name: string;
  githubRepoId: number | null;  // GitHub's numeric repo ID
  // ...existing fields
}
```

When creating a repo, GitHub returns the `id` - we store it for future reconnection.

### UI Guidance

```
┌─────────────────────────────────────────────────────────────┐
│  Connect GitHub                                              │
│                                                              │
│  When prompted, select "Only select repositories".           │
│  Tisket will only access repos it creates for your           │
│  projects and teams - never your codebases.                  │
│                                                              │
│  [Connect GitHub]                                            │
└─────────────────────────────────────────────────────────────┘
```

## GitHub App Setup (Admin Steps)

### 1. Create the GitHub App

Go to **github.com/organizations/tisket-com/settings/apps/new**

| Field | Value |
|-------|-------|
| App name | Tisket |
| Homepage URL | `https://tisket.com` |
| Callback URL | `https://app.tisket.com/github/callback` |
| Setup URL (optional) | `https://app.tisket.com/github/setup` |
| Webhook URL | `https://api.tisket.com/webhooks/github` |
| Webhook secret | Generate a random string |

#### Permissions

**Repository permissions:**
- Contents: Read & Write
- Metadata: Read
- Administration: Write (to create repos)

**Organization permissions:**
- Members: Read (optional)

#### Webhook events
- `installation`
- `installation_repositories`

### 2. Generate Private Key

After creating the app:
1. Scroll to "Private keys" section
2. Click "Generate a private key"
3. Downloads a `.pem` file - store securely

### 3. Note the App ID

Copy the **App ID** from the app's settings page (a number like `123456`)

### 4. Install on tisket-com

1. Go to the app's public page or "Install App" in settings
2. Select `tisket-com` organization
3. Choose "Only select repositories" (none needed initially)
4. Authorize

The **installation_id** will be returned in the callback/webhook.

### 5. Configure Environment

```bash
GITHUB_APP_ID=<App ID>
GITHUB_APP_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\n..."
GITHUB_APP_WEBHOOK_SECRET=<webhook secret>
```

## Implementation

### 1. Database Schema

```typescript
interface GitHubInstallation {
  id: string;
  organizationId: string;     // WorkOS org ID
  installationId: number;     // GitHub's installation ID
  accountLogin: string;       // "tisket-com"
  accountType: "Organization" | "User";
  createdAt: Date;
  suspendedAt: Date | null;
}

// Update existing repos table
interface Repo {
  // ...existing fields
  githubRepoId: number | null;  // Store for reconnection
}
```

### 2. Code Changes

| File | Change |
|------|--------|
| `shared/src/db/schema.ts` | Add github_installations table, add githubRepoId to repos |
| `mcp/src/lib/github-app.ts` | New: JWT signing, token exchange |
| `mcp/src/operations/repos.ts` | Use installation token, store githubRepoId on create |
| `mcp/src/lib/worktree.ts` | Dynamic org from installation |
| `client/src/routes/workspace/settings/repos/index.tsx` | Add GitHub connection section |
| `client/src/routes/github/callback.tsx` | New: OAuth callback, restore repo access |

### 3. Token Exchange Flow

```typescript
async function getInstallationToken(installationId: number): Promise<string> {
  const jwt = signAppJwt();  // RS256 with private key
  const response = await fetch(
    `https://api.github.com/app/installations/${installationId}/access_tokens`,
    { method: "POST", headers: { Authorization: `Bearer ${jwt}` } }
  );
  return (await response.json()).token;  // Valid 1 hour
}
```

### 4. Reconnection Flow

```typescript
async function restoreRepoAccess(installationId: number, orgId: string): Promise<void> {
  const token = await getInstallationToken(installationId);
  const repos = await db.query.repos.findMany({
    where: eq(repos.organizationId, orgId),
  });

  for (const repo of repos) {
    if (repo.githubRepoId) {
      await fetch(
        `https://api.github.com/user/installations/${installationId}/repositories/${repo.githubRepoId}`,
        { method: "PUT", headers: { Authorization: `Bearer ${token}` } }
      );
    }
  }
}
```

### 5. Webhook Handler

Handle events: `installation.deleted`, `installation.suspended`, `installation.unsuspended`

## UI: Repositories Settings Page

Add a "GitHub Connection" section at the top of the existing Repositories settings page (`/workspace/settings/repos`). This is the natural location since repos require a GitHub connection.

### Connected State
```
┌─────────────────────────────────────────────────────────────┐
│  GitHub Connection                                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ✓ Connected to tisket-com                          │    │
│  │    Organization · Installed Jan 15, 2026            │    │
│  │                                                     │    │
│  │    [Manage on GitHub]    [Disconnect]               │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  Projects (3)                                                │
│  ...                                                         │
└─────────────────────────────────────────────────────────────┘
```

### Disconnected State
```
┌─────────────────────────────────────────────────────────────┐
│  GitHub Connection                                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Connect your GitHub organization or account to     │    │
│  │  store projects and tickets in your own repos.      │    │
│  │                                                     │    │
│  │    [Connect GitHub]                                 │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  Projects                                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Connect GitHub to create projects                  │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### Access Control
- Only org admins (WorkOS role) can connect/disconnect GitHub
- Members see the connection status but cannot modify it

## Testing Strategy

1. Create GitHub App in GitHub UI (admin steps above)
2. Install on tisket-com org with "Only select repositories"
3. Verify app can create repos and auto-gains access
4. Test reconnection flow with stored githubRepoId
5. Validate full flow before building install UI

## Benefits

- Users own their repositories
- Never access customer codebases (only Tisket-created repos)
- Scoped tokens (no shared PAT)
- Audit trail in GitHub
- No rate limit concerns per-org
- Seamless reconnection via stored repo IDs
