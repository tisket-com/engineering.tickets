---
status: open
priority: high
created: 2026-02-01
---
# TKT-033: Implement GitHub App authentication for multi-tenant repository access

## Summary

Replace the current single `GITHUB_PAT` + `GITHUB_ORG` approach with GitHub App authentication, allowing each WorkOS organization to connect their own GitHub account/org as the upstream repository.

## Architecture

```
WorkOS Org ────→ GitHub Installation ────→ GitHub Org/Account

org_01ABC...  ──→  install_12345  ──→  tisket-com
org_02DEF...  ──→  install_67890  ──→  acme-corp
```

All users within a WorkOS organization share the same GitHub connection.

## Implementation

### 1. Create GitHub App
- Name: Tisket
- Permissions: Repository contents (R/W), Metadata (R)
- Webhook URL: `https://api.tisket.com/webhooks/github`
- Callback URL: `https://app.tisket.com/github/callback`

### 2. Database Schema

```typescript
interface GitHubInstallation {
  id: string;
  organizationId: string;     // WorkOS org ID
  installationId: number;     // GitHub's installation ID
  accountLogin: string;       // "tisket-com"
  accountType: "Organization" | "User";
  createdAt: Date;
  suspendedAt: Date | null;
}
```

### 3. Environment Variables

Replace `GITHUB_PAT` and `GITHUB_ORG` with:
```
GITHUB_APP_ID=
GITHUB_APP_PRIVATE_KEY=
GITHUB_APP_WEBHOOK_SECRET=
```

### 4. Code Changes

| File | Change |
|------|--------|
| `shared/src/db/schema.ts` | Add github_installations table |
| `mcp/src/lib/github-app.ts` | New: JWT signing, token exchange |
| `mcp/src/operations/repos.ts` | Use installation token instead of PAT |
| `mcp/src/lib/worktree.ts` | Dynamic org from installation |
| `client/src/routes/workspace/settings/repos/index.tsx` | Add GitHub connection section |
| `client/src/routes/github/callback.tsx` | New: OAuth callback handler |

### 5. Token Exchange Flow

```typescript
async function getInstallationToken(installationId: number): Promise<string> {
  const jwt = signAppJwt();  // RS256 with private key
  const response = await fetch(
    `https://api.github.com/app/installations/${installationId}/access_tokens`,
    { method: "POST", headers: { Authorization: `Bearer ${jwt}` } }
  );
  return (await response.json()).token;  // Valid 1 hour
}
```

### 6. Webhook Handler

Handle events: `installation.deleted`, `installation.suspended`, `installation.unsuspended`

## UI: Repositories Settings Page

Add a "GitHub Connection" section at the top of the existing Repositories settings page (`/workspace/settings/repos`). This is the natural location since repos require a GitHub connection.

### Connected State
```
┌─────────────────────────────────────────────────────────────┐
│  GitHub Connection                                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ✓ Connected to tisket-com                          │    │
│  │    Organization · Installed Jan 15, 2026            │    │
│  │                                                     │    │
│  │    [Manage on GitHub]    [Disconnect]               │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  Projects (3)                                                │
│  ...                                                         │
└─────────────────────────────────────────────────────────────┘
```

### Disconnected State
```
┌─────────────────────────────────────────────────────────────┐
│  GitHub Connection                                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Connect your GitHub organization or account to     │    │
│  │  store projects and tickets in your own repos.      │    │
│  │                                                     │    │
│  │    [Connect GitHub]                                 │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  Projects                                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Connect GitHub to create projects                  │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### Access Control
- Only org admins (WorkOS role) can connect/disconnect GitHub
- Members see the connection status but cannot modify it

## Testing Strategy

1. Create GitHub App in GitHub UI
2. Install on tisket-com org
3. Manually seed installation record for testing
4. Validate full flow before building install UI

## Benefits

- Users own their repositories
- Scoped tokens (no shared PAT)
- Audit trail in GitHub
- No rate limit concerns per-org
