---
status: open
priority: high
created: 2026-02-01
---
# TKT-033: Implement GitHub App authentication for multi-tenant repository access

## Summary

Replace the current single `GITHUB_PAT` + `GITHUB_ORG` approach with GitHub App authentication, allowing each WorkOS organization to connect their own GitHub account/org as the upstream repository.

## Architecture

```
WorkOS Org ────→ GitHub Installation ────→ GitHub Org/Account

org_01ABC...  ──→  install_12345  ──→  tisket-com
org_02DEF...  ──→  install_67890  ──→  acme-corp
```

All users within a WorkOS organization share the same GitHub connection.

## GitHub App Setup (Admin Steps)

### 1. Create the GitHub App

Go to **github.com/organizations/tisket-com/settings/apps/new**

| Field | Value |
|-------|-------|
| App name | Tisket |
| Homepage URL | `https://tisket.com` |
| Callback URL | `https://app.tisket.com/github/callback` |
| Setup URL (optional) | `https://app.tisket.com/github/setup` |
| Webhook URL | `https://api.tisket.com/webhooks/github` |
| Webhook secret | Generate a random string |

#### Permissions

**Repository permissions:**
- Contents: Read & Write
- Metadata: Read

**Organization permissions:**
- Members: Read (optional)

#### Webhook events
- `installation`
- `installation_repositories`

### 2. Generate Private Key

After creating the app:
1. Scroll to "Private keys" section
2. Click "Generate a private key"
3. Downloads a `.pem` file - store securely

### 3. Note the App ID

Copy the **App ID** from the app's settings page (a number like `123456`)

### 4. Install on tisket-com

1. Go to the app's public page or "Install App" in settings
2. Select `tisket-com` organization
3. Choose "All repositories" or select specific ones
4. Authorize

The **installation_id** will be returned in the callback/webhook.

### 5. Configure Environment

```bash
GITHUB_APP_ID=<App ID>
GITHUB_APP_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\n..."
GITHUB_APP_WEBHOOK_SECRET=<webhook secret>
```

## Implementation

### 1. Database Schema

```typescript
interface GitHubInstallation {
  id: string;
  organizationId: string;     // WorkOS org ID
  installationId: number;     // GitHub's installation ID
  accountLogin: string;       // "tisket-com"
  accountType: "Organization" | "User";
  createdAt: Date;
  suspendedAt: Date | null;
}
```

### 2. Code Changes

| File | Change |
|------|--------|
| `shared/src/db/schema.ts` | Add github_installations table |
| `mcp/src/lib/github-app.ts` | New: JWT signing, token exchange |
| `mcp/src/operations/repos.ts` | Use installation token instead of PAT |
| `mcp/src/lib/worktree.ts` | Dynamic org from installation |
| `client/src/routes/workspace/settings/repos/index.tsx` | Add GitHub connection section |
| `client/src/routes/github/callback.tsx` | New: OAuth callback handler |

### 3. Token Exchange Flow

```typescript
async function getInstallationToken(installationId: number): Promise<string> {
  const jwt = signAppJwt();  // RS256 with private key
  const response = await fetch(
    `https://api.github.com/app/installations/${installationId}/access_tokens`,
    { method: "POST", headers: { Authorization: `Bearer ${jwt}` } }
  );
  return (await response.json()).token;  // Valid 1 hour
}
```

### 4. Webhook Handler

Handle events: `installation.deleted`, `installation.suspended`, `installation.unsuspended`

## UI: Repositories Settings Page

Add a "GitHub Connection" section at the top of the existing Repositories settings page (`/workspace/settings/repos`). This is the natural location since repos require a GitHub connection.

### Connected State
```
┌─────────────────────────────────────────────────────────────┐
│  GitHub Connection                                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ✓ Connected to tisket-com                          │    │
│  │    Organization · Installed Jan 15, 2026            │    │
│  │                                                     │    │
│  │    [Manage on GitHub]    [Disconnect]               │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  Projects (3)                                                │
│  ...                                                         │
└─────────────────────────────────────────────────────────────┘
```

### Disconnected State
```
┌─────────────────────────────────────────────────────────────┐
│  GitHub Connection                                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Connect your GitHub organization or account to     │    │
│  │  store projects and tickets in your own repos.      │    │
│  │                                                     │    │
│  │    [Connect GitHub]                                 │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  Projects                                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Connect GitHub to create projects                  │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### Access Control
- Only org admins (WorkOS role) can connect/disconnect GitHub
- Members see the connection status but cannot modify it

## Testing Strategy

1. Create GitHub App in GitHub UI (admin steps above)
2. Install on tisket-com org
3. Manually seed installation record for initial testing
4. Validate full flow before building install UI

## Benefits

- Users own their repositories
- Scoped tokens (no shared PAT)
- Audit trail in GitHub
- No rate limit concerns per-org
