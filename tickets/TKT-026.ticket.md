---
status: open
priority: low
created: 2026-01-28
---
# TKT-026: MCP Server Future Enhancements: Diff Edit Tool & Worktree Isolation

## Overview

Two potential future enhancements for the MCP server, documented for when/if needed.

---

## 1. Diff/Patch Edit Tool

### Problem
The `write` tool sends the entire file content on every call. For large files with small edits, this wastes tokens and context space.

### Proposal
Add an `edit` tool similar to Claude Code's Edit tool:

```typescript
{
  name: "edit",
  inputSchema: {
    file_path: string,
    old_string: string,  // Must be unique in file
    new_string: string,
    replace_all?: boolean
  }
}
```

### Tradeoffs

| Full Write (current) | Diff Edit |
|---------------------|-----------|
| Simple, no state | Smaller payloads |
| Works for new files | Must match old_string uniquely |
| No conflict risk | Can fail if file changed |
| Idempotent | Edge cases (whitespace, encoding) |

### When to implement
- When token/context usage becomes an issue
- When editing large documentation files (10KB+) frequently
- Current use case (tickets ~500B, configs ~1KB) doesn't need it

---

## 2. Per-User Worktree Isolation

### Current State
Infrastructure exists in `lib/worktree.ts` but isn't wired up. All users share the same working directory per repo.

### What's Built
- `getOrCreateWorktree(userId, repoSlug)` - Creates isolated worktree
- `commitAndPushWorktree()` - Merges session branch to main
- `cleanupStaleWorktrees()` - Removes old worktrees
- Session tracking for active worktrees

### What's Missing
- Write operations don't use worktrees yet (see comment in files.ts)
- Need to wire up worktree creation on first write
- Need to handle merge conflicts in commit_changes

### When to implement
- When multiple users edit the same repo simultaneously
- When we need atomic multi-file transactions
- Current single-user MCP usage doesn't need it

---

## References
- TKT-025: Original simple-git migration
- `mcp/src/lib/worktree.ts`: Worktree infrastructure
- `mcp/src/operations/files.ts`: Write operations (line ~115 comment)
