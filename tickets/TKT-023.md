
status: resolved
priority: medium
created: 2026-01-26
resolved: 2026-01-26

# TKT-023: Use database as source of truth for repo discovery

## Summary

`discoverRepos()` was calling GitHub REST API on every invocation, including route loaders. Now the database is the source of truth for known repos.

## Implementation

### Client changes (`client/src/lib/repos.ts`)

```typescript
// DB-only query for normal use
export async function getRepos(): Promise<Repo[]> {
  const dbRepos = await db.query.repos.findMany();
  return dbRepos.map(dbRepo => ({
    slug: dbRepo.slug,
    name: dbRepo.name,
    type: inferRepoType(dbRepo.slug),
    description: ghRepoCache.get(dbRepo.slug)?.description ?? null,
    defaultBranch: ghRepoCache.get(dbRepo.slug)?.default_branch ?? "main",
  }));
}

// Explicit sync for discovering new repos from GitHub
export async function syncReposFromGitHub(): Promise<Repo[]> {
  const ghRepos = await listRepos();
  await syncReposToDb(ghRepos);
  ghRepoCache = new Map(ghRepos.map(r => [r.name, r]));
  return getRepos();
}
```

### tRPC router changes (`client/src/trpc/routers/repos.ts`)

- `repos.list` → uses `getRepos()` (DB only)
- `repos.sync` → new mutation using `syncReposFromGitHub()`
- `repos.getWorkspaceData` → uses `getRepos()`
- `repos.getProjectsOverview` → uses `getRepos()`

### MCP changes

**`mcp/src/operations/repos.ts`:**
- Added `syncRepoToDb()` - inserts repo into DB immediately after GitHub creation

**`mcp/src/lib/workspaces.ts`:**
- Added `ensureRepoInDb()` - ensures repo exists when adding to workspace

### Workspace context (`client/src/components/workspace-context.tsx`)

- Added `syncFromGitHub()` method for UI access to explicit sync

## Data Flow

1. MCP creates repo on GitHub
2. MCP inserts into `repos` table immediately
3. Client queries `repos.list` → reads from DB only
4. New repo appears instantly in sidebar

## Benefits

- Eliminates `GET /orgs/{org}/repos` from normal page loads
- Faster workspace navigation (DB query vs API call)
- No rate limit concerns for repo listing
- GitHub API only called on explicit user action
- New repos created via MCP appear immediately

## Commits

- `a853906` - Client-side: getRepos(), syncReposFromGitHub(), tRPC changes
- `5d8225c` - MCP-side: syncRepoToDb(), ensureRepoInDb()

## Related

- TKT-021: GitHub App evaluation (this fix may reduce need)
- TKT-022: REST API write path removal

---

## Comments

**2026-01-26** — *James Holland*

Testing inline comments - this should append to the ticket file directly instead of creating a separate file.

&nbsp;

**2026-01-26** — *Claude*

Implemented the fix:

**Changes:**
- `client/src/lib/repos.ts`: Added `getRepos()` (DB-only) and `syncReposFromGitHub()` (explicit sync)
- `client/src/trpc/routers/repos.ts`: Changed `repos.list` to use `getRepos()`, added `repos.sync` mutation
- `client/src/components/workspace-context.tsx`: Added `syncFromGitHub()` method for UI access

**How it works:**
- Normal page loads now query the database directly via `getRepos()`
- When MCP creates a repo, it inserts into the DB, so it appears immediately
- `syncFromGitHub()` can be called explicitly to discover new repos from GitHub

Commit: a853906

&nbsp;

**2026-01-26** — *Claude*

Added MCP-side sync to complete the fix:

**Additional changes:**
- `mcp/src/operations/repos.ts`: Added `syncRepoToDb()` - inserts repo into DB immediately after GitHub creation
- `mcp/src/lib/workspaces.ts`: Added `ensureRepoInDb()` - ensures repo exists in DB when adding to workspace

**Full data flow now:**
1. MCP creates repo on GitHub
2. MCP inserts into `repos` table (new)
3. Client queries `repos.list` → reads from DB only (no GitHub API)
4. New repo appears instantly in sidebar

Commit: 5d8225c

&nbsp;
