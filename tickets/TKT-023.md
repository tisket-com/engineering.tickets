---
status: open
priority: medium
created: 2026-01-26
---
# TKT-023: Use database as source of truth for repo discovery

## Summary

`discoverRepos()` currently calls GitHub REST API on every invocation, including route loaders. The database should be the source of truth for known repos.

## Current State

`client/src/lib/repos.ts`:
```typescript
export async function discoverRepos(): Promise<Repo[]> {
  const ghRepos = await listRepos();  // ‚Üê Calls GitHub API every time
  await syncReposToDb(ghRepos);
  // ...
}
```

Called from:
- `workspace.tsx` route loader (every workspace page load)
- tRPC `repos.list` procedure
- tRPC `repos.listByType` procedure
- tRPC `repos.getWorkspaceData` procedure

This means every workspace navigation hits GitHub's REST API unnecessarily.

## Proposed Changes

### 1. Split discovery from querying

```typescript
// For normal queries - DB only
export async function getRepos(): Promise<Repo[]> {
  return db.query.repos.findMany();
}

// For explicit sync - calls GitHub
export async function syncReposFromGitHub(): Promise<void> {
  const ghRepos = await listRepos();
  await syncReposToDb(ghRepos);
}
```

### 2. Update callers

- Route loaders: use `getRepos()` (DB only)
- "Add repo" UI: use `syncReposFromGitHub()` then show available
- Settings page: add "Sync repos" button that calls GitHub

### 3. Handle unassigned repos

The DB already tracks:
- `repos` - all known repos
- `workspaceProjects` / `workspaceTeams` - assigned repos

Query for unassigned: repos not in any workspace's projects/teams.

## Benefits

- Eliminates `GET /orgs/{org}/repos` from normal page loads
- Faster workspace navigation (DB query vs API call)
- No rate limit concerns for repo listing
- GitHub API only called on explicit user action

## Related

- TKT-021: GitHub App evaluation (this fix may eliminate need)
- TKT-022: REST API write path removal
