---
status: open
priority: high
created: 2026-01-30
---
# TKT-028: Remove all GitHub REST API calls from client

## Problem

The client makes direct GitHub REST API calls for read and write operations. This violates the architecture guideline: "All read operations should use local git, not REST API."

Current issues:
- `getRecentActivity` makes ~25+ API calls per invocation
- 404 errors for deleted files still in commit history
- Short `staleTime` (5s) causes repeated refetches
- Rate limit concerns (5,000/hour)
- Client bypasses MCP server for operations it should handle
- SSE adds complexity for realtime updates

## Solution

**Delete `lib/github.ts` entirely.** All operations should flow through:
- **Reads**: Browser git clone (via git protocol fetch from GitHub)
- **Writes**: tRPC → MCP server (which handles GitHub operations)

**Replace SSE with ref polling.** Poll the `heads` endpoint every 2 seconds. This is cheap (MCP reads local `.git/refs/heads/main` files - microseconds) and effectively real-time.

### Change Detection
Add a `heads` tRPC endpoint that returns current HEAD sha for each repo from MCP server's local clones. Client polls every 2 seconds, compares to browser git HEADs, and triggers a `git fetch` only for repos where HEAD differs.

Note: `clone` happens once on first repo access (stored in IndexedDB via LightningFS). All subsequent updates use `fetch` to pull new commits - never re-cloning.

### Hook Renaming
Simplify verbose hook names:
| Old | New |
|-----|-----|
| `useMultiRepoBoards` | `useBoards` |
| `useMultiRepoTicketsParsed` | `useTickets` |
| `useMultiRepoFiles` | `useFiles` |
| (new) | `useActivity` |

## Scope

### Delete entirely:
- `client/src/lib/github.ts` - all GitHub REST API code
- `client/src/routes/api/repo-bootstrap.ts` - uses REST API
- `client/src/routes/api/repo-history.ts` - uses REST API
- `client/src/hooks/use-realtime-events.ts` - SSE hook, replaced by polling
- SSE server endpoint

### Migrate to browser git:
- `lib/content.ts` - use `useFiles` / `useGitFile` patterns
- `lib/tickets.ts` - use `useTickets` hook
- `lib/timelines.ts` - create `useTimelines` hook
- `lib/reports.ts` - create `useReports` hook

### Migrate to MCP server:
- Repo creation: already handled by MCP `create_project` / `create_team` tools
- Repo discovery: MCP server knows what repos exist (workspaces track membership)

### Update components:
- `components/projects-overview.tsx` - use `useActivity` hook
- `components/tickets-overview.tsx` - use `useActivity` hook
- `components/browser-git-context.tsx` - remove SSE, add ref polling
- `trpc/routers/repos.ts` - remove REST API imports, add `heads` endpoint

## Implementation

### 1. Add `heads` endpoint
```ts
// tRPC router
heads: protectedProcedure
  .input(z.object({ repoSlugs: z.array(z.string()) }))
  .query(async ({ input }) => {
    // Read HEAD from MCP server's local clones (file read, instant)
    // Returns { heads: { [slug]: sha } }
  })
```

### 2. Replace SSE with polling hook
```ts
function useHeadsPolling(repoSlugs: string[], interval = 2000) {
  // Poll `heads` endpoint every 2 seconds
  // Compare to browser git HEADs
  // Call repo.fetch() for repos where HEAD differs
  // Increment version to trigger hook re-renders
}
```

### 3. Create `useActivity` hook
```ts
function useActivity(repoSlugs: string[]) {
  // Read recent commits from browser git clones via repo.log()
  // Return combined, sorted activity feed
}
```

### 4. Rename hooks
- `useMultiRepoBoards` → `useBoards`
- `useMultiRepoTicketsParsed` → `useTickets`
- `useMultiRepoFiles` → `useFiles`

### 5. Delete code
- Delete `lib/github.ts`
- Delete `routes/api/repo-bootstrap.ts`
- Delete `routes/api/repo-history.ts`
- Delete `hooks/use-realtime-events.ts`
- Delete SSE server endpoint
- Remove all imports of deleted code

## Verification

Run these searches to confirm completion:

```bash
# Should return NO results - GitHub REST API eliminated
rg "api\.github\.com" client/src/
rg "getRepoContents|getFileContent|getRepoCommits|getCommitDetail" client/src/
rg "getHeadSha|getFileTree|getFileCommitHistory|getGitCommitObject" client/src/

# Should return NO results - deleted files gone
ls client/src/lib/github.ts
ls client/src/routes/api/repo-bootstrap.ts
ls client/src/routes/api/repo-history.ts
ls client/src/hooks/use-realtime-events.ts

# Should return NO results - SSE removed
rg "EventSource|useRealtimeEvents|text/event-stream" client/src/

# Should return NO results - old hook names gone
rg "useMultiRepoBoards|useMultiRepoTicketsParsed|useMultiRepoFiles" client/src/

# Should return results - new patterns in place
rg "useBoards|useTickets|useFiles|useActivity" client/src/components/
rg "useHeadsPolling|heads.*endpoint" client/src/
rg "refetchInterval.*2000" client/src/
```

## Outcome
After this ticket:
- Zero GitHub REST API calls from client
- No SSE - just simple ref polling every 2 seconds
- All reads from browser git clone
- All writes through MCP server
- Simpler architecture, fewer moving parts
