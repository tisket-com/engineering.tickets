---
status: open
priority: high
created: 2026-01-29
updated: 2026-01-30
---
# TKT-027: Client Service Desk Architecture - Threads & Email Gateway

## Overview

Architecture decisions for how external clients interact with Tisket as a service desk. This covers the client-facing "threads" model, email integration, and how it bridges to internal ticketing.

---

## Naming Convention

**Decision:** Use "Inboxes" as the container for client threads.

| Concept | Container | Contents |
|---------|-----------|----------|
| Documentation | Projects | Markdown files |
| Internal work | Teams | Tickets |
| Client support | **Inboxes** | **Threads** |

**Rationale:**
- Self-describing: an inbox contains threads, obvious
- Email-native: matches the architecture (webhook receives email → thread)
- No jargon: everyone knows what an inbox is
- No namespace collision: "inbox" isn't overloaded in tech (unlike "service", "client", "desk")

**Rejected alternatives:**
- "Desks" → evokes "service desk" but informal
- "Services" → overloaded in tech (microservices, SaaS, cloud services)
- "Clients" → conflicts with "client-side" in tech contexts
- "Accounts" → implies billing/commercial relationship

---

## Inbox Provisioning

When an inbox is created, Tisket automatically provisions a Postmark inbound address:

```
<inbox_name>.<org_slug>@tisket.com
```

**Note:** "Organization" here refers to the WorkOS Organization (the tenant), not the user's personal workspace.

**Examples:**
- Org "acme", inbox "support" → `support.acme@tisket.com`
- Org "acme", inbox "billing" → `billing.acme@tisket.com`
- Org "globex", inbox "help" → `help.globex@tisket.com`

**Implementation:**
- On inbox creation, call Postmark API to create inbound address
- Store the generated address in the `inboxes` table
- Postmark webhook routes all inbound email to Tisket's single webhook endpoint
- Webhook parses `To` address to identify organization + inbox

**Constraints:**
- Inbox names must be unique within an organization
- Inbox names must be valid email local-part characters (lowercase, alphanumeric, hyphens)
- Organization slugs are already validated for URL safety (from WorkOS)

**Future: Custom Domains**
Custom domains (Phase 4) would allow `support@clientcorp.com` instead of `support.acme@tisket.com`. The Postmark address remains as a fallback/internal address.

---

## Thread ID Format

**Decision:** Use org-prefixed sequential IDs: `[THD-ACME-001]`

**Format:** `[THD-<ORG>-<SEQ>]`
- `THD` - Fixed prefix identifying Tisket threads
- `<ORG>` - Organization slug (uppercase)
- `<SEQ>` - Sequential number within the inbox

**Examples:**
- `[THD-ACME-001]` - First thread for Acme
- `[THD-ACME-047]` - 47th thread for Acme
- `[THD-GLOBEX-012]` - 12th thread for Globex

**Why this format:**
- Human-readable: you can see which org it belongs to at a glance
- Debuggable: easy to identify in email subjects
- Sequential numbers are meaningful (thread #47 tells you rough volume)
- Collision-resistant: different orgs have different prefixes

**Security:** Thread ID can be sequential/guessable because security is handled by participant validation (see below), not by obscuring IDs.

**Regex pattern:** `\[THD-[A-Z0-9]+-\d+\]`

---

## Reply Security: Participant Validation

**Decision:** Only allow replies from people who have participated in the thread.

**How it works:**
1. When a message arrives (new thread or reply), record all email addresses involved (From, To, CC)
2. On subsequent replies, check: is the sender in the participant list?
3. Yes → accept message, No → reject or flag for review

**Example flow:**
1. Alice (`alice@clientcorp.com`) emails inbox → thread created, Alice added to participants
2. Staff replies → staff's inbox address captured, staff added to participants
3. Alice replies, CC's Bob (`bob@clientcorp.com`) and Eve (`eve@consultant.com`) → Bob and Eve added to participants
4. Eve replies → **allowed** (she's now a participant)
5. Random attacker with thread ID replies → **rejected** (not a participant)

**Why this approach:**
- Simple: just check "has this person been in the conversation?"
- Matches natural email behavior: anyone CC'd can participate
- No complex domain whitelists or configuration needed
- Industry-standard approach (similar to how other ticketing systems validate)

**Security note:** This prevents attackers from injecting messages into threads even if they guess a valid thread ID. They would need to have been part of the email chain.

---

## Key Decisions

### 1. Threads vs Tickets (Two Distinct Concepts)

**Decision:** Client-facing interactions are "threads" (simple), internal work is "tickets" (complex).

| Threads (Client-Facing) | Tickets (Internal) |
|-------------------------|---------------------|
| Subject + status + messages | Full workflow |
| Open, in_progress, resolved, closed | Priority, SLA, assignee |
| No internal notes | Internal notes, discussions |
| Simple conversation | Links to other tickets, metadata |

**Rationale:** Clients don't need ticketing complexity. They need a conversation with status. All internal complexity stays in `.tickets` repos.

### 2. Storage Format: HTML (Not Markdown)

**Decision:** Store thread messages as HTML, not markdown.

**Rationale:**
- Emails arrive as HTML
- HTML→Markdown conversion is lossy and complex
- Would require AI to extract actual content from email HTML (quoted replies, signatures, etc.)
- If we're building a UI anyway, it can render HTML
- Git's text-diff benefits don't apply to HTML blobs

### 3. Storage Backend: Database (Not Git)

**Decision:** Threads stored in a database, not git repos.

**Rationale:**
- Git benefits (version history, offline, distributed) don't add much for append-only conversations
- Threads are simple CRUD operations
- Real-time updates easier with database
- HTML content makes git diffs meaningless anyway
- Database is the right tool for this job

**Note:** Internal `.tickets` repos remain git-based (markdown, version history matters).

### 4. Email Integration: Postmark Webhooks

**Decision:** Use Postmark webhooks for inbound email.

**Why Postmark:**
- Excellent inbound email parsing
- Simple webhook configuration
- Good documentation and reliability
- Supports custom domains for outbound

**Rejected alternatives:**
- Email forwarding - breaks SPF/DKIM, adds latency
- IMAP/OAuth polling - complex setup, polling delays

**Webhook advantages:**
- Real-time (no polling)
- Email parsing handled by Postmark
- Low ops burden
- Works with custom domains

### 5. Email Threading: Auto-Acknowledgment Model

**Decision:** Establish thread IDs via auto-acknowledgment emails sent on thread creation.

**Flow:**
1. Client emails `support.acme@tisket.com` with subject "Login issue"
2. Postmark webhook → Tisket creates thread THD-ACME-001
3. Tisket sends auto-acknowledgment via Postmark:
   - To: client
   - From: `support.acme@tisket.com`
   - Subject: `[THD-ACME-001] Re: Login issue`
   - Body: "Your request has been received. Reference: THD-ACME-001"
4. Client replies → subject contains `[THD-ACME-001]` → matched to thread
5. Staff replies (with inbox CC'd) → subject contains `[THD-ACME-001]` → matched to thread

**Why auto-acknowledgment:**
- Works regardless of staff email client (no add-on required for replies)
- Thread ID established immediately on creation
- Client gets confirmation their email was received
- Industry-standard pattern for support systems

**Auto-ack content:**
Keep it short and useful:
> "Your request has been received and we'll respond shortly. Reference: THD-ACME-001"

**Configurable:** Auto-acknowledgment can be disabled per inbox if not desired.

### 6. Staff Reply Method

**Decision:** Staff reply via their normal email client with the inbox address in CC/To.

**Flow:**
1. Staff sees thread in Tisket UI
2. Staff replies via Gmail/Outlook/any client, keeping inbox address in the conversation
3. Reply goes to client AND hits Postmark webhook
4. Tisket stores the message in the thread

**Why this works:**
- Thread ID already in subject (from auto-ack)
- No add-on needed for replies
- Staff use familiar tools
- Works with any email client (Gmail, Outlook, Apple Mail, etc.)

**Add-ons (optional, lower priority):**
Gmail/Outlook add-ons only needed for staff *initiating* new outbound threads (contacting a client first). For replies to existing threads, no add-on required.

### 7. Custom Domain Support (Multi-tenant)

**Decision:** Support customers using their own email domains.

**Requirements per customer:**
- MX record pointing to Postmark
- SPF record authorizing Postmark
- DKIM CNAME for signatures
- Domain verification in Postmark

**Implementation:**
- Inbox identification via `To` address on inbound
- Outbound sends `From` customer's domain
- Database scoped by inbox

**Recommendation:** Start with single domain (`@tisket.com`), add custom domains as premium feature.

### 8. No AI Intermediary for Email

**Decision:** Email gateway has no AI processing. Raw email → thread storage.

**The MCP is the bridge:**
- AI agents read threads via MCP
- AI agents create/update internal tickets
- AI agents can draft replies (but humans send via email client)
- MCP handles the mapping, not the email gateway

---

## Email Flow Diagram

```
NEW THREAD (Client initiates):

  Client                    Postmark                   Tisket
     │                         │                          │
     │── Email to inbox ──────►│                          │
     │                         │── Webhook ──────────────►│
     │                         │                          │ Create thread THD-ACME-001
     │                         │                          │ Add client to participants
     │◄── Auto-ack ────────────│◄── Send auto-ack ───────│
     │   [THD-ACME-001] Re:... │                          │
     │                         │                          │
```

```
REPLY (Client or Staff):

  Client/Staff              Postmark                   Tisket
     │                         │                          │
     │── Reply ───────────────►│                          │
     │   [THD-ACME-001] Re:... │── Webhook ──────────────►│
     │                         │                          │ Check sender in participants
     │                         │                          │ ✓ Add message to thread
     │                         │                          │ Add any new CC's to participants
     │                         │                          │
```

```
INTERNAL TICKETING (Unchanged):

  AI Agent ◄────▶ MCP ◄────▶ .tickets repo (git)
                   │
                   │ reads threads (read-only)
                   ▼
            Thread Storage (database)
```

---

## Data Model

### Threads (Database)

```sql
CREATE TABLE inboxes (
  id                TEXT PRIMARY KEY,
  organization_id   TEXT NOT NULL,           -- WorkOS Organization ID
  name              TEXT NOT NULL,           -- e.g. "support"
  email_address     TEXT UNIQUE NOT NULL,    -- e.g. "support.acme@tisket.com"
  custom_domain     TEXT,                    -- e.g. "support@clientcorp.com" (Phase 4)
  auto_ack_enabled  BOOLEAN DEFAULT TRUE,    -- Send auto-acknowledgment on new threads
  auto_ack_message  TEXT,                    -- Custom auto-ack message (optional)
  next_thread_seq   INTEGER DEFAULT 1,       -- Next sequential thread number
  created_at        TIMESTAMP,
  UNIQUE(organization_id, name)
);

CREATE TABLE threads (
  id            TEXT PRIMARY KEY,   -- THD-ACME-001
  inbox_id      TEXT REFERENCES inboxes(id),
  subject       TEXT,
  status        TEXT,               -- open, in_progress, resolved, closed
  created_at    TIMESTAMP,
  updated_at    TIMESTAMP
);

CREATE TABLE thread_participants (
  thread_id     TEXT REFERENCES threads(id),
  email         TEXT NOT NULL,
  added_at      TIMESTAMP,
  PRIMARY KEY (thread_id, email)
);

CREATE TABLE messages (
  id            TEXT PRIMARY KEY,
  thread_id     TEXT REFERENCES threads(id),
  message_id    TEXT,               -- Email Message-ID header
  direction     TEXT,               -- inbound, outbound
  from_address  TEXT,
  to_addresses  TEXT[],             -- Array of To recipients
  cc_addresses  TEXT[],             -- Array of CC recipients
  body_html     TEXT,
  created_at    TIMESTAMP
);

CREATE TABLE attachments (
  id            TEXT PRIMARY KEY,
  message_id    TEXT REFERENCES messages(id),
  filename      TEXT,
  content_type  TEXT,
  storage_path  TEXT                -- S3/R2 path
);
```

### Internal Ticket Link

```yaml
# In engineering.tickets/TKT-042.md
---
status: in_progress
priority: high
assignee: "@sarah"
client_thread:
  inbox: acme-support
  thread_id: THD-ACME-001
---
```

---

## Inbound Message Processing

When a message arrives via Postmark webhook:

```
1. Parse thread ID from subject: [THD-ACME-001]
   
2. If no thread ID found:
   → Create new thread
   → Add sender to participants
   → Send auto-acknowledgment (if enabled)
   → Store message
   
3. If thread ID found:
   → Look up thread
   → Check: is sender in thread_participants?
     → No: Reject or flag for review
     → Yes: Continue
   → Add message to thread
   → Add any new CC addresses to participants
   → Update thread.updated_at
```

---

## MCP Tools Needed

```typescript
// Inbox operations
list_inboxes(organization_id?)
get_inbox(inbox_id)
create_inbox(organization_id, name)  // provisions Postmark address

// Thread operations (read-only, used by AI agents via MCP)
list_threads(inbox_id, status?)
get_thread(thread_id)
get_thread_participants(thread_id)
update_thread_status(thread_id, status)

// Linking
link_thread_to_ticket(thread_id, ticket_id)
get_ticket_for_thread(thread_id)
```

---

## Add-on Architecture (Lower Priority)

Add-ons are only needed for staff *initiating* new outbound threads (contacting a client first, before the client has emailed). For replies to existing threads, no add-on is required since the thread ID is already in the subject.

### Gmail Add-on

- Official Google Apps Script API
- `gmail.composeTrigger` to hook into email composition
- Query Tisket API for existing thread by recipient
- Use `UpdateDraftSubjectAction` to append `[THD-ORG-xxx]` if needed

### Outlook Web Add-in

- Official Microsoft Office.js API
- Compose mode activation
- Query Tisket API for existing thread
- Modify subject field if needed

### Platform Coverage

| Platform | Covered | Notes |
|----------|---------|-------|
| Gmail (web/mobile) | ✅ | Via Gmail Add-on |
| Outlook (web/desktop/mobile) | ✅ | Via Outlook Add-in |
| Apple Mail | ❌ | Manual subject management |
| Other IMAP clients | ❌ | Manual subject management |

For unsupported clients, staff can manually include thread ID in subject, or initiate threads from Tisket UI (future feature).

---

## Implementation Phases

### Phase 1: Core Email Gateway
- Postmark webhook endpoint for inbound email
- Inbox/thread/message storage (database)
- Inbox provisioning (auto-create Postmark inbound address)
- Thread ID generation (`THD-ORG-SEQ`)
- Participant tracking and validation
- Auto-acknowledgment on new thread creation
- Thread matching by subject line

### Phase 2: Tisket Thread Viewer
- Internal tab to view threads (read-only)
- Link threads to internal tickets
- Filter by status, inbox, date
- View participant list

### Phase 3: Gmail/Outlook Add-ons (Lower Priority)
- Gmail Add-on (Apps Script)
- Outlook Web Add-in (Office.js)
- Only needed for staff-initiated outbound threads

### Phase 4: Multi-inbox / Custom Domains
- Per-inbox configuration
- Custom domain onboarding in Postmark
- Domain verification

### ~~Client Portal (Deprioritized)~~
~~- Web UI for clients to view their threads~~
~~- Direct message submission (no email)~~

**Note:** Client portal deprioritized. Clients use email. Internal team views threads in Tisket.

---

## Open Questions

1. **Attachment storage:** S3/R2 vs database blobs?
2. **Real-time:** WebSockets for live thread updates in Tisket viewer?
3. **Add-on distribution:** Internal only, or publish to marketplaces?
4. **Rejected messages:** What to do with messages that fail participant validation? Silent drop, bounce, or flag for review?

---

## References

- [Gmail Add-ons Compose UI](https://developers.google.com/apps-script/add-ons/gmail/extending-compose-ui)
- [Outlook Add-ins Overview](https://learn.microsoft.com/en-us/office/dev/add-ins/outlook/outlook-add-ins-overview)
- [Outlook Compose Add-ins](https://learn.microsoft.com/en-us/office/dev/add-ins/outlook/compose-scenario)
- [Postmark Inbound Email](https://postmarkapp.com/developer/user-guide/inbound)
