---
status: open
priority: high
created: 2026-01-29
updated: 2026-01-30
---
# TKT-027: Client Service Desk Architecture - Threads & Email Gateway

## Overview

Architecture decisions for how external clients interact with Tisket as a service desk. This covers the client-facing "threads" model, email integration, and how it bridges to internal ticketing.

---

## Naming Convention

**Decision:** Use "Inboxes" as the container for client threads.

| Concept | Container | Contents |
|---------|-----------|----------|
| Documentation | Projects | Markdown files |
| Internal work | Teams | Tickets |
| Client support | **Inboxes** | **Threads** |

**Rationale:**
- Self-describing: an inbox contains threads, obvious
- Email-native: matches the architecture (webhook receives email → thread)
- No jargon: everyone knows what an inbox is
- No namespace collision: "inbox" isn't overloaded in tech (unlike "service", "client", "desk")

**Rejected alternatives:**
- "Desks" → evokes "service desk" but informal
- "Services" → overloaded in tech (microservices, SaaS, cloud services)
- "Clients" → conflicts with "client-side" in tech contexts
- "Accounts" → implies billing/commercial relationship

---

## Inbox Provisioning

When an inbox is created, Tisket automatically provisions a Postmark inbound address:

```
<inbox_name>.<org_slug>@tisket.com
```

**Note:** "Organization" here refers to the WorkOS Organization (the tenant), not the user's personal workspace.

**Examples:**
- Org "acme", inbox "support" → `support.acme@tisket.com`
- Org "acme", inbox "billing" → `billing.acme@tisket.com`
- Org "globex", inbox "help" → `help.globex@tisket.com`

**Implementation:**
- On inbox creation, call Postmark API to create inbound address
- Store the generated address in the `inboxes` table
- Postmark webhook routes all inbound email to Tisket's single webhook endpoint
- Webhook parses `To` address to identify organization + inbox

**Constraints:**
- Inbox names must be unique within an organization
- Inbox names must be valid email local-part characters (lowercase, alphanumeric, hyphens)
- Organization slugs are already validated for URL safety (from WorkOS)

**Future: Custom Domains**
Custom domains (Phase 4) would allow `support@clientcorp.com` instead of `support.acme@tisket.com`. The Postmark address remains as a fallback/internal address.

---

## Key Decisions

### 1. Threads vs Tickets (Two Distinct Concepts)

**Decision:** Client-facing interactions are "threads" (simple), internal work is "tickets" (complex).

| Threads (Client-Facing) | Tickets (Internal) |
|-------------------------|---------------------|
| Subject + status + messages | Full workflow |
| Open, in_progress, resolved, closed | Priority, SLA, assignee |
| No internal notes | Internal notes, discussions |
| Simple conversation | Links to other tickets, metadata |

**Rationale:** Clients don't need ticketing complexity. They need a conversation with status. All internal complexity stays in `.tickets` repos.

### 2. Storage Format: HTML (Not Markdown)

**Decision:** Store thread messages as HTML, not markdown.

**Rationale:**
- Emails arrive as HTML
- HTML→Markdown conversion is lossy and complex
- Would require AI to extract actual content from email HTML (quoted replies, signatures, etc.)
- If we're building a UI anyway, it can render HTML
- Git's text-diff benefits don't apply to HTML blobs

### 3. Storage Backend: Database (Not Git)

**Decision:** Threads stored in a database, not git repos.

**Rationale:**
- Git benefits (version history, offline, distributed) don't add much for append-only conversations
- Threads are simple CRUD operations
- Real-time updates easier with database
- HTML content makes git diffs meaningless anyway
- Database is the right tool for this job

**Note:** Internal `.tickets` repos remain git-based (markdown, version history matters).

### 4. Email Integration: Postmark Webhooks

**Decision:** Use Postmark webhooks for inbound email.

**Why Postmark:**
- Excellent inbound email parsing
- Simple webhook configuration
- Good documentation and reliability
- Supports custom domains for outbound

**Rejected alternatives:**
- Email forwarding - breaks SPF/DKIM, adds latency
- IMAP/OAuth polling - complex setup, polling delays

**Webhook advantages:**
- Real-time (no polling)
- Email parsing handled by Postmark
- Low ops burden
- Works with custom domains

### 5. Email Threading: Auto-Acknowledgment Model

**Decision:** Establish thread IDs via auto-acknowledgment emails sent on thread creation.

**Flow:**
1. Client emails `support.acme@tisket.com` with subject "Login issue"
2. Postmark webhook → Tisket creates thread THD-123
3. Tisket sends auto-acknowledgment via Postmark:
   - To: client
   - From: `support.acme@tisket.com`
   - Subject: `[THD-123] Re: Login issue`
   - Body: "Your request has been received. Reference: THD-123"
4. Client replies → subject contains `[THD-123]` → matched to thread
5. Staff replies (with inbox CC'd) → subject contains `[THD-123]` → matched to thread

**Why auto-acknowledgment:**
- Works regardless of staff email client (no add-on required for replies)
- Thread ID established immediately on creation
- Client gets confirmation their email was received
- Industry-standard pattern for support systems

**Matching logic:**
- Parse `[THD-xxx]` from subject line
- Use distinctive format unlikely to conflict with other ticketing systems

**Auto-ack content:**
Keep it short and useful:
> "Your request has been received and we'll respond shortly. Reference: THD-123"

**Configurable:** Auto-acknowledgment can be disabled per inbox if not desired.

### 6. Staff Reply Method

**Decision:** Staff reply via their normal email client with the inbox address in CC/To.

**Flow:**
1. Staff sees thread in Tisket UI
2. Staff replies via Gmail/Outlook/any client, keeping inbox address in the conversation
3. Reply goes to client AND hits Postmark webhook
4. Tisket stores the message in the thread

**Why this works:**
- Thread ID already in subject (from auto-ack)
- No add-on needed for replies
- Staff use familiar tools
- Works with any email client (Gmail, Outlook, Apple Mail, etc.)

**Add-ons (optional, lower priority):**
Gmail/Outlook add-ons only needed for staff *initiating* new outbound threads (contacting a client first). For replies to existing threads, no add-on required.

### 7. Custom Domain Support (Multi-tenant)

**Decision:** Support customers using their own email domains.

**Requirements per customer:**
- MX record pointing to Postmark
- SPF record authorizing Postmark
- DKIM CNAME for signatures
- Domain verification in Postmark

**Implementation:**
- Inbox identification via `To` address on inbound
- Outbound sends `From` customer's domain
- Database scoped by inbox

**Recommendation:** Start with single domain (`@tisket.com`), add custom domains as premium feature.

### 8. No AI Intermediary for Email

**Decision:** Email gateway has no AI processing. Raw email → thread storage.

**The MCP is the bridge:**
- AI agents read threads via MCP
- AI agents create/update internal tickets
- AI agents can draft replies (but humans send via email client)
- MCP handles the mapping, not the email gateway

---

## Email Flow Diagram

```
NEW THREAD (Client initiates):

  Client                    Postmark                   Tisket
     │                         │                          │
     │── Email to inbox ──────►│                          │
     │                         │── Webhook ──────────────►│
     │                         │                          │ Create thread THD-123
     │◄── Auto-ack ────────────│◄── Send auto-ack ───────│
     │   [THD-123] Re: Subject │                          │
     │                         │                          │
```

```
REPLY (Client or Staff):

  Client/Staff              Postmark                   Tisket
     │                         │                          │
     │── Reply ───────────────►│                          │
     │   [THD-123] Re: Subject │── Webhook ──────────────►│
     │                         │                          │ Match by [THD-123]
     │                         │                          │ Add message to thread
     │                         │                          │
```

```
INTERNAL TICKETING (Unchanged):

  AI Agent ◄────▶ MCP ◄────▶ .tickets repo (git)
                   │
                   │ reads threads (read-only)
                   ▼
            Thread Storage (database)
```

---

## Data Model

### Threads (Database)

```sql
CREATE TABLE inboxes (
  id                TEXT PRIMARY KEY,
  organization_id   TEXT NOT NULL,           -- WorkOS Organization ID
  name              TEXT NOT NULL,           -- e.g. "support"
  email_address     TEXT UNIQUE NOT NULL,    -- e.g. "support.acme@tisket.com"
  custom_domain     TEXT,                    -- e.g. "support@clientcorp.com" (Phase 4)
  auto_ack_enabled  BOOLEAN DEFAULT TRUE,    -- Send auto-acknowledgment on new threads
  auto_ack_message  TEXT,                    -- Custom auto-ack message (optional)
  created_at        TIMESTAMP,
  UNIQUE(organization_id, name)
);

CREATE TABLE threads (
  id            TEXT PRIMARY KEY,   -- THD-123
  inbox_id      TEXT REFERENCES inboxes(id),
  subject       TEXT,
  status        TEXT,               -- open, in_progress, resolved, closed
  client_email  TEXT,
  client_name   TEXT,
  created_at    TIMESTAMP,
  updated_at    TIMESTAMP
);

CREATE TABLE messages (
  id            TEXT PRIMARY KEY,
  thread_id     TEXT REFERENCES threads(id),
  message_id    TEXT,               -- Email Message-ID header
  direction     TEXT,               -- inbound, outbound
  from_address  TEXT,
  body_html     TEXT,
  created_at    TIMESTAMP
);

CREATE TABLE attachments (
  id            TEXT PRIMARY KEY,
  message_id    TEXT REFERENCES messages(id),
  filename      TEXT,
  content_type  TEXT,
  storage_path  TEXT                -- S3/R2 path
);
```

### Internal Ticket Link

```yaml
# In engineering.tickets/TKT-042.md
---
status: in_progress
priority: high
assignee: "@sarah"
client_thread:
  inbox: acme-support
  thread_id: THD-123
---
```

---

## MCP Tools Needed

```typescript
// Inbox operations
list_inboxes(organization_id?)
get_inbox(inbox_id)
create_inbox(organization_id, name)  // provisions Postmark address

// Thread operations (read-only, used by AI agents via MCP)
list_threads(inbox_id, status?)
get_thread(thread_id)
update_thread_status(thread_id, status)

// Linking
link_thread_to_ticket(thread_id, ticket_id)
get_ticket_for_thread(thread_id)
```

---

## Add-on Architecture (Lower Priority)

Add-ons are only needed for staff *initiating* new outbound threads (contacting a client first, before the client has emailed). For replies to existing threads, no add-on is required since the thread ID is already in the subject.

### Gmail Add-on

- Official Google Apps Script API
- `gmail.composeTrigger` to hook into email composition
- Query Tisket API for existing thread by recipient
- Use `UpdateDraftSubjectAction` to append `[THD-xxx]` if needed

### Outlook Web Add-in

- Official Microsoft Office.js API
- Compose mode activation
- Query Tisket API for existing thread
- Modify subject field if needed

### Platform Coverage

| Platform | Covered | Notes |
|----------|---------|-------|
| Gmail (web/mobile) | ✅ | Via Gmail Add-on |
| Outlook (web/desktop/mobile) | ✅ | Via Outlook Add-in |
| Apple Mail | ❌ | Manual subject management |
| Other IMAP clients | ❌ | Manual subject management |

For unsupported clients, staff can manually include thread ID in subject, or initiate threads from Tisket UI (future feature).

---

## Implementation Phases

### Phase 1: Core Email Gateway
- Postmark webhook endpoint for inbound email
- Inbox/thread/message storage (database)
- Inbox provisioning (auto-create Postmark inbound address)
- Auto-acknowledgment on new thread creation
- Thread matching by subject line `[THD-xxx]`

### Phase 2: Tisket Thread Viewer
- Internal tab to view threads (read-only)
- Link threads to internal tickets
- Filter by status, inbox, date

### Phase 3: Gmail/Outlook Add-ons (Lower Priority)
- Gmail Add-on (Apps Script)
- Outlook Web Add-in (Office.js)
- Only needed for staff-initiated outbound threads

### Phase 4: Multi-inbox / Custom Domains
- Per-inbox configuration
- Custom domain onboarding in Postmark
- Domain verification

### ~~Client Portal (Deprioritized)~~
~~- Web UI for clients to view their threads~~
~~- Direct message submission (no email)~~

**Note:** Client portal deprioritized. Clients use email. Internal team views threads in Tisket.

---

## Open Questions

1. **Attachment storage:** S3/R2 vs database blobs?
2. **Real-time:** WebSockets for live thread updates in Tisket viewer?
3. **Add-on distribution:** Internal only, or publish to marketplaces?
4. **Thread ID format:** Sequential per inbox, global counter, or include random token for security?

---

## References

- [Gmail Add-ons Compose UI](https://developers.google.com/apps-script/add-ons/gmail/extending-compose-ui)
- [Outlook Add-ins Overview](https://learn.microsoft.com/en-us/office/dev/add-ins/outlook/outlook-add-ins-overview)
- [Outlook Compose Add-ins](https://learn.microsoft.com/en-us/office/dev/add-ins/outlook/compose-scenario)
- [Postmark Inbound Email](https://postmarkapp.com/developer/user-guide/inbound)
