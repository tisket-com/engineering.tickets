---
status: open
priority: medium
created: 2026-01-26
---
# TKT-022: Remove REST API write path from client - use MCP git push

## Summary

The client has two write paths that should be consolidated:
1. **Client tRPC** → REST API `PUT /repos/.../contents/...` (current)
2. **MCP server** → git commit + push (correct approach)

All writes should go through MCP's git push for consistency.

## Current State

`client/src/trpc/routers/repos.ts` uses `updateFileContent()` which:
1. Calls `GET /repos/{org}/{repo}/contents/{path}` to get current SHA
2. Calls `PUT /repos/{org}/{repo}/contents/{path}` to write

This is used for:
- Board updates (lines 390, 415)
- File writes (lines 529, 566)

## MCP Approach (Correct)

MCP server (`mcp/src/operations/`) does:
1. `fs.writeFile()` to local clone
2. `git.commit()` 
3. `git.push()`

This is better because:
- Uses git protocol (separate rate limits from REST API)
- Consistent with the "git as source of truth" architecture
- Proper commit history with author attribution
- SSE events already work with this flow

## Implementation Options

### Option A: Route writes through MCP (Recommended)

**How it works:**
Client tRPC → MCP HTTP endpoint → MCP writes to local clone → git commit → git push

**Pros:**
- Single source of truth for write logic
- MCP already handles SSE events for realtime updates
- Proper commit authorship (MCP knows user context)
- Works for Claude Code and web client identically
- Minimal new code - just wire tRPC to existing MCP endpoints

**Cons:**
- Extra network hop (client → server → MCP → GitHub)
- MCP must be running/reachable for web client writes
- Latency: ~200-500ms added vs direct API

**Implementation:**
1. Delete `updateFileContent` from `client/src/lib/github.ts`
2. Add tRPC procedure that calls MCP's existing write endpoint
3. Done - no new logic, just wiring

---

### Option B: Client-side git push (isomorphic-git)

**How it works:**
Browser isomorphic-git → write to IndexedDB clone → git commit → git push via `/api/git/` proxy → GitHub

**Pros:**
- Writes happen locally first (optimistic, fast UI)
- Works offline (commit locally, push when online)
- Browser git clone stays in sync automatically
- No MCP dependency for web client
- True "local-first" architecture

**Cons:**
- Need to implement git push auth - `/api/git/` proxy needs write credentials
- Commit authorship - browser needs user's git identity configured
- Duplicate write logic - MCP and browser both have implementations
- More complex conflict handling (see below)

---

### Option C: Hybrid (simple writes client-side, complex through MCP)

**Pros:**
- Fast path for common operations
- MCP for complex orchestration

**Cons - significantly more complex:**
- Two write paths to implement and maintain
- Decision logic needed: "is this simple or complex?"
- Edge cases: what if a "simple" write fails and needs retry through MCP?
- Testing burden: need to test both paths, plus handoff between them
- State sync: browser git clone and MCP clone could diverge
- Bugs where one path works, other doesn't - hard to reproduce
- Unclear benefit over committing to A or B

---

## Conflict Handling

Conflicts can happen with any approach - the question is where you handle them.

**Option A (MCP):**
- Conflict handling centralized on server
- MCP can fetch, detect conflict, auto-rebase or return error
- Client shows simple "conflict, please refresh" message
- One implementation to maintain

**Option B (Browser):**
- Conflict handling in browser JavaScript
- Need UI for "conflict detected, pull changes?"
- Can't easily do server-side auto-rebase
- Same complexity as A, but duplicated in browser

**Option C:**
- Conflict handling in both places
- Need to handle conflicts differently depending on which path was used
- Most complex

## Recommendation

**Start with Option A** because:
1. MCP write logic already exists and works
2. Simplest to implement (remove client code, wire to MCP)
3. SSE realtime updates already connected
4. Centralized conflict handling
5. Can evolve to Option B later if offline/latency becomes important

## Related

- TKT-021: GitHub App evaluation (this fix reduces REST API dependency)
- TKT-023: DB as source of truth for repos
- CLAUDE.md architecture guidelines
